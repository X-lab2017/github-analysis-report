SELECT repo_id,
    floor(avg(resolve_period)) AS resolve_period_avg,
    floor(avg(respond_period)) AS respond_period_avg,
    median(resolve_period) AS resolve_period_median,
    median(respond_period) AS respond_period_median,
    count(1) AS count
FROM (
        SELECT repo_id,
            issue_number,
            close_at - open_at As resolve_period,
            interact_at - open_at AS respond_period
        FROM (
                SELECT oi.repo_id As repo_id,
                    oi.issue_number AS issue_number,
                    oi.time AS open_at,
                    ci.time AS close_at,
                    ii.time As interact_at
                FROM (
                        SELECT repo_id,
                            issue.number,
                            min(created_at) AS time
                        FROM github_log.year2020
                        WHERE (repo_id IN [{{repo_ids}}])
                            AND (type IN ['IssuesEvent'])
                            AND (action IN ['opened'])
                        GROUP BY repo_id,
                            issue_number
                    ) AS oi 
                    INNER JOIN (
                        SELECT repo_id,
                            issue_number,
                            min(created_at) AS time
                        FROM github_log.year2020
                        WHERE (repo_id IN [{{repo_ids}}])
                            AND (type IN ['IssuesEvent'])
                            AND (action IN ['closed'])
                        GROUP BY repo_id,
                            issue_number
                    ) AS ci ON (oi.repo_id = ci.repo_id)
                    AND (oi.issue_number = ci.issue_number)
                    INNER JOIN (
                        SELECT repo_id,
                            issue_number,
                            min(created_at) AS time
                        FROM github_log.year2020
                        WHERE (repo_id IN [{{repo_ids}}])
                            AND (type IN ['IssueCommentEvent', 'IssuesEvent'])
                            AND (action IN ['created', 'closed'])
                            AND (actor_id NOT IN [{{banned_actor_ids}}])
                            AND (actor_id != issue_author_id)
                            AND (actor_login NOT LIKE '%[bot]')
                        GROUP BY repo_id,
                            issue_number
                    ) AS ii ON (oi.repo_id = ii.repo_id)
                    AND (oi.issue_number = ii.issue_number)
            )
    )